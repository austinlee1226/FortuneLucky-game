<style>
    /* 強化彩帶容器：確保 z-index 最高，且不影響點擊 */
    #confetti-cannon { 
        position: absolute; 
        left: 360px; 
        top: 350px; /* 調整到捲軸上方一點 */
        width: 1px; 
        height: 1px; 
        z-index: 900; /* 極高層級，確保噴在最前面 */
        pointer-events: none; 
    }
    .confetti { 
        position: absolute; 
        width: 12px; 
        height: 12px; 
        border-radius: 2px;
        opacity: 0; 
    }
</style>

<div id="game-stage">
    <div id="confetti-cannon" class="layer"></div>
</div>

<script>
    // 修正後的噴彩帶函式
    function spawnConfetti() {
        const colors = ['#FFD700', '#FF4500', '#FF69B4', '#00FF7F', '#1E90FF', '#FFFFFF'];
        const cannon = document.getElementById('confetti-cannon');
        
        // 增加到 80 顆，讓效果更華麗
        for (let i = 0; i < 80; i++) {
            const dot = document.createElement('div');
            dot.className = 'confetti';
            dot.style.background = colors[Math.floor(Math.random() * colors.length)];
            cannon.appendChild(dot);

            // 計算噴射角度與力量
            const angle = (Math.random() * 180 - 180) * (Math.PI / 180); // 向上半圓噴發
            const velocity = 10 + Math.random() * 15;
            const tx = Math.cos(angle) * (200 + Math.random() * 300);
            const ty = Math.sin(angle) * (200 + Math.random() * 300) + 500; // 最終落下位置

            dot.animate([
                { transform: 'translate(0, 0) scale(1) rotate(0deg)', opacity: 1 },
                { transform: `translate(${tx}px, ${ty}px) scale(0.5) rotate(${Math.random() * 720}deg)`, opacity: 0 }
            ], { 
                duration: 2000 + Math.random() * 1000, 
                easing: 'cubic-bezier(0.1, 0.8, 0.3, 1)' 
            });

            // 動畫結束後移除元素，節省效能
            setTimeout(() => dot.remove(), 3000);
        }
    }

    // 在 handleCopyClick 成功拿到序號後呼叫
    async function handleCopyClick() {
        const serialEl = document.getElementById('serial-text');
        serialEl.innerText = "領取中...";
        try {
            const response = await fetch(`${API_URL}?action=claim`);
            const serialCode = await response.text();
            if (serialCode && serialCode !== "") {
                serialEl.innerText = serialCode;
                
                // 執行複製
                const el = document.createElement('textarea');
                el.value = serialCode;
                document.body.appendChild(el); el.select();
                document.execCommand('copy');
                document.body.removeChild(el);

                // 視覺回饋：噴彩帶 + 按鈕切換
                spawnConfetti(); 
                document.getElementById('btn-copy').classList.add('hidden');
                document.getElementById('btn-reward').classList.remove('hidden');
            } else {
                serialEl.innerText = "序號已領完";
            }
        } catch (e) { serialEl.innerText = "網路異常"; }
    }
</script>